<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>èœ˜è››çº¸ç‰Œ - å•èŠ±è‰²</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #1a4d1a 0%, #0d330d 50%, #0a2a0a 100%);
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            overflow: hidden;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 10px;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 15px;
            margin-bottom: 5px;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .timer {
            color: #fff;
            font-size: 14px;
            font-family: monospace;
            background: rgba(0,0,0,0.3);
            padding: 4px 10px;
            border-radius: 4px;
        }

        .toolbar-right {
            display: flex;
            gap: 8px;
        }

        .toolbar-btn {
            background: rgba(0,0,0,0.3);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 4px 12px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toolbar-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.2);
        }

        .toolbar-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* æ¸¸æˆä¸»åŒºåŸŸï¼š10åˆ—ç‰Œ */
        .game-board {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 8px;
            padding: 0 20px;
            padding-top: 40px;
        }

        .column {
            width: 90px;
            min-height: 400px;
            position: relative;
        }

        /* åº•éƒ¨åŒºåŸŸï¼šå›æ”¶åŒºå’Œå‘ç‰ŒåŒº */
        .bottom-area {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 140px;
            padding: 10px 20px;
        }

        /* å›æ”¶åŒº - å·¦ä¸‹è§’ */
        .foundation {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 8px;
        }

        .foundation-slot {
            width: 280px;
            height: 130px;
            border-radius: 8px;
            position: relative;
        }

        .foundation-slot.completed {
            border: none;
            background: transparent;
        }

        .foundation-slot .card {
            width: 80px;
            height: 110px;
            position: absolute;
        }

        .foundation-slot .card .card-face {
            padding: 5px;
        }

        .foundation-slot .card .card-corner .card-rank {
            font-size: 16px;
        }

        .foundation-slot .card .card-corner .card-suit-small {
            font-size: 12px;
        }

        .foundation-slot .card .card-center {
            font-size: 36px;
        }

        /* å‘ç‰ŒåŒº - å³ä¸‹è§’ */
        .stock-area {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .stock-pile {
            width: 100px;
            height: 145px;
            position: relative;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .stock-pile.disabled {
            cursor: not-allowed;
            opacity: 0.4;
        }

        .stock-pile:not(.disabled):hover {
            transform: scale(1.05);
        }

        .stock-count {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        /* æ¸¸æˆä¸»åŒºåŸŸï¼š10åˆ—ç‰Œ */
        .game-board {
            flex: 1;
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 0 20px;
        }

        .column {
            width: 100px;
            min-height: 450px;
            position: relative;
        }

        .column.valid-target {
            border: 2px dashed rgba(255, 215, 0, 0.6);
            background: rgba(255, 215, 0, 0.1);
            border-radius: 8px;
        }

        /* çº¸ç‰Œæ ·å¼ */
        .card {
            width: 100px;
            height: 145px;
            border-radius: 8px;
            position: absolute;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .card-face {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            background: #fff;
            border: 1px solid #ccc;
        }

        .card-back {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            background: linear-gradient(135deg, #2c5aa0 0%, #1e4080 50%, #1a3570 100%);
            border: 3px solid #fff;
            position: relative;
            overflow: hidden;
        }

        .card-back::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70px;
            height: 100px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(255, 255, 255, 0.05) 5px,
                rgba(255, 255, 255, 0.05) 10px
            );
        }

        .card.face-up .card-back {
            display: none;
        }

        .card.face-down .card-face {
            display: none;
        }

        .card-corner {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1;
        }

        .card-corner.top {
            align-self: flex-start;
        }

        .card-corner.bottom {
            align-self: flex-end;
            transform: rotate(180deg);
        }

        .card-rank {
            font-size: 22px;
            font-weight: bold;
            color: #000;
        }

        .card-suit-small {
            font-size: 16px;
            color: #000;
        }

        .card-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 54px;
            color: #000;
        }

        .card.selected {
            box-shadow: 0 0 0 3px #ffd700, 0 8px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000 !important;
        }

        .card.click-selected {
            box-shadow: 0 0 0 3px #ffd700, 0 8px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000 !important;
        }

        .card.dragging {
            transition: none;
            z-index: 1001 !important;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
            cursor: grabbing;
        }

        .card.invalid-move {
            animation: shake 0.3s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .card.hint-highlight {
            animation: hintPulse 0.8s ease infinite;
        }

        @keyframes hintPulse {
            0%, 100% { box-shadow: 0 0 0 3px #ffd700; }
            50% { box-shadow: 0 0 15px 5px #ffd700; }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        .card.fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card.flip {
            animation: flipIn 0.3s ease;
        }

        @keyframes flipIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        /* èƒœåˆ©å¼¹çª— */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: linear-gradient(135deg, #2d5016 0%, #1a3009 100%);
            padding: 40px 60px;
            border-radius: 15px;
            text-align: center;
            border: 3px solid #4a7c23;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-title {
            color: #ffd700;
            font-size: 36px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .modal-btn {
            background: linear-gradient(135deg, #4a7c23 0%, #3d6a1c 100%);
            color: #fff;
            border: 2px solid #6ba332;
            padding: 12px 40px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 20px;
        }

        .modal-btn:hover {
            background: linear-gradient(135deg, #5a8c33 0%, #4d7a2c 100%);
            transform: scale(1.05);
        }

        /* æç¤ºä¿¡æ¯ */
        .message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1500;
        }

        .message.show {
            opacity: 1;
        }

        .modal-content.small {
            padding: 25px 40px;
        }

        .modal-content.small .modal-title {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .modal-content.small .modal-text {
            color: #fff;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .modal-btn.small {
            padding: 8px 20px;
            font-size: 14px;
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="toolbar">
            <div class="toolbar-left">
                <span class="timer" id="timer">ç”¨æ—¶ï¼š0åˆ†0ç§’</span>
            </div>
            <div class="toolbar-right">
                <button class="toolbar-btn" id="hintBtn">ğŸ’¡ æç¤º (3)</button>
                <button class="toolbar-btn" id="undoBtn">â†©ï¸ æ’¤é”€ (3)</button>
                <button class="toolbar-btn" id="restartBtn">ğŸ”„ é‡ç©</button>
            </div>
        </div>
        <!-- æ¸¸æˆä¸»åŒºåŸŸï¼š10åˆ—ç‰Œ -->
        <div class="game-board" id="gameBoard"></div>

            <!-- åº•éƒ¨åŒºåŸŸï¼šå›æ”¶åŒºå’Œå‘ç‰ŒåŒº -->
            <div class="bottom-area">
                <!-- å›æ”¶åŒºï¼š1ä¸ªslotï¼Œå †å æ˜¾ç¤º -->
                <div class="foundation">
                    <div class="foundation-slot" data-index="0"></div>
                </div>
            <!-- å‘ç‰ŒåŒº -->
            <div class="stock-area">
                <div class="stock-pile" id="stockPile">
                    <div class="card">
                        <div class="card-back"></div>
                    </div>
                    <span class="stock-count" id="stockCount">50</span>
                </div>
            </div>
        </div>
    </div>

    <!-- èƒœåˆ©å¼¹çª— -->
    <div class="modal" id="winModal">
        <div class="modal-content">
            <h1 class="modal-title">æ­å–œé€šå…³ï¼</h1>
            <p style="color: #fff; font-size: 18px;">æ‚¨å·²æ”¶é›†8ç»„K-Aåºåˆ—</p>
            <p style="color: #ffd700; font-size: 16px; margin-top: 10px;" id="winTime"></p>
            <button class="modal-btn" onclick="game.restart()">å†æ¥ä¸€å±€</button>
        </div>
    </div>

    <!-- æ­»é”å¼¹çª— -->
    <div class="modal" id="deadlockModal">
        <div class="modal-content small">
            <h2 class="modal-title" style="color: #ff6b6b;">æ— æ³•ç§»åŠ¨</h2>
            <p class="modal-text">å‘ç‰ŒåŒºå·²å‘å®Œï¼Œä¸”æ²¡æœ‰å¯ç§»åŠ¨çš„ç‰Œç»„</p>
            <div>
                <button class="modal-btn small" id="deadlockUndoBtn">â†©ï¸ æ’¤é”€</button>
                <button class="modal-btn small" onclick="game.restart()">ğŸ”„ é‡ç©</button>
            </div>
        </div>
    </div>

    <!-- æç¤ºä¿¡æ¯ -->
    <div class="message" id="message"></div>

    <script>
        /**
         * èœ˜è››çº¸ç‰Œæ¸¸æˆ - å•èŠ±è‰²ç‰ˆæœ¬
         * 
         * æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š
         * - cards: æ‰€æœ‰ç‰Œçš„æ•°ç»„ï¼Œæ¯å¼ ç‰ŒåŒ…å« suit, rank, faceUp, id
         * - columns: 10åˆ—ç‰Œç»„ï¼Œæ¯åˆ—æ˜¯ç‰Œçš„æ•°ç»„
         * - stock: å‘ç‰ŒåŒºçš„ç‰Œï¼ˆèƒŒé¢æœä¸Šï¼‰
         * - foundation: å›æ”¶åŒºï¼Œæ”¶é›†å®Œæˆçš„K-Aåºåˆ—
         * 
         * æ ¸å¿ƒé€»è¾‘ï¼š
         * 1. åˆå§‹åŒ–ï¼šç”Ÿæˆ8å¥—104å¼ ç‰Œï¼Œæ´—ç‰Œï¼Œå‘åˆå§‹54å¼ åˆ°10åˆ—
         * 2. æ‹–æ‹½ï¼šåªèƒ½æ‹–åŠ¨æ­£é¢æœä¸Šçš„è¿ç»­é€’å‡åºåˆ—
         * 3. æ”¾ç½®ï¼šç›®æ ‡ç‰Œå¿…é¡»ç‚¹æ•°å¤§1ï¼ˆ5â†’6ï¼‰ï¼Œç©ºåˆ—å¯æ”¾ä»»æ„ç‰Œ
         * 4. åºåˆ—æ£€æµ‹ï¼šå½¢æˆK-AåŒèŠ±è‰²åºåˆ—åç§»åˆ°å›æ”¶åŒº
         * 5. é€šå…³ï¼š8ç»„K-Aå®Œæˆåæ˜¾ç¤ºèƒœåˆ©
         */
        class SpiderSolitaire {
            constructor() {
                this.columns = [];
                this.stock = [];
                this.foundation = [];
                this.dragState = null;
                this.selectedCard = null;
                this.completedCount = 0;
                this.dealCount = 0;

                this.timerInterval = null;
                this.startTime = null;
                this.undoCount = 3;
                this.hintCount = 3;
                this.lastState = null;
                this.hintElements = [];

                this.clickSelection = {
                    colIndex: null,
                    cardIndex: null,
                    cards: [],
                    validTargets: []
                };

                this.init();
            }

            /**
             * åˆå§‹åŒ–æ¸¸æˆ
             */
            init() {
                this.createDeck();
                this.shuffleDeck();
                this.dealInitialCards();
                this.undoCount = 3;
                this.hintCount = 3;
                this.lastState = null;
                this.render();
                this.bindEvents();
                this.startTimer();
                this.updateToolbar();
            }

            /**
             * åˆ›å»ºç‰Œç»„ï¼š8å¥—104å¼ é»‘æ¡ƒèŠ±è‰²
             */
            createDeck() {
                this.cards = [];
                const suits = ['â™ ']; // å•èŠ±è‰²ï¼šé»‘æ¡ƒ
                const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
                
                // ç”Ÿæˆ8å¥—ç‰Œï¼ˆ104å¼ ï¼‰
                for (let set = 0; set < 8; set++) {
                    for (let rank = 0; rank < 13; rank++) {
                        this.cards.push({
                            id: `${set}-${rank}`,
                            suit: suits[0],
                            rank: rank + 1, // 1-13
                            rankDisplay: ranks[rank],
                            faceUp: false,
                            setId: set // è®°å½•å±äºå“ªä¸€å¥—
                        });
                    }
                }
            }

            /**
             * æ´—ç‰Œï¼šéšæœºæ‰“ä¹±ç‰Œåº
             */
            shuffleDeck() {
                for (let i = this.cards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.cards[i], this.cards[j]] = [this.cards[j], this.cards[i]];
                }
            }

            /**
             * å¼€å§‹è®¡æ—¶å™¨
             */
            startTimer() {
                this.stopTimer();
                this.startTime = Date.now();
                this.updateTimer();
                this.timerInterval = setInterval(() => this.updateTimer(), 1000);
            }

            /**
             * åœæ­¢è®¡æ—¶å™¨
             */
            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }

            /**
             * æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
             */
            updateTimer() {
                const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timerEl = document.getElementById('timer');
                if (timerEl) {
                    timerEl.textContent = `ç”¨æ—¶ï¼š${minutes}åˆ†${seconds}ç§’`;
                }
            }

            /**
             * è·å–æ ¼å¼åŒ–ç”¨æ—¶
             */
            getElapsedTime() {
                const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                return `${minutes}åˆ†${seconds}ç§’`;
            }

            /**
             * åˆå§‹å‘ç‰Œï¼šå‰4åˆ—å„6å¼ ï¼Œå6åˆ—å„5å¼ ï¼Œå…±54å¼ 
             */
            dealInitialCards() {
                this.columns = Array(10).fill(null).map(() => []);

                // å‰4åˆ—å„6å¼ 
                for (let col = 0; col < 4; col++) {
                    for (let i = 0; i < 6; i++) {
                        const card = this.cards.pop();
                        if (i === 5) card.faceUp = true; // æ¯åˆ—æœ€åä¸€å¼ ç¿»å¼€
                        this.columns[col].push(card);
                    }
                }

                // å6åˆ—å„5å¼ 
                for (let col = 4; col < 10; col++) {
                    for (let i = 0; i < 5; i++) {
                        const card = this.cards.pop();
                        if (i === 4) card.faceUp = true; // æ¯åˆ—æœ€åä¸€å¼ ç¿»å¼€
                        this.columns[col].push(card);
                    }
                }

                // å‰©ä½™50å¼ åˆ°å‘ç‰ŒåŒº
                this.stock = [...this.cards];
                this.cards = [];
            }

            /**
             * å‘ç‰Œï¼šæ¯è½®å‘10å¼ ï¼ˆæ¯åˆ—1å¼ ï¼‰ï¼Œå…±5è½®
             */
            dealCards() {
                const canDeal = this.columns.every(col => 
                    col.length > 0 && col.some(card => card.faceUp)
                );

                if (!canDeal) {
                    this.showMessage('æ¯åˆ—éœ€è¦æœ‰æ­£é¢æœä¸Šçš„ç‰Œæ‰èƒ½å‘ç‰Œ');
                    return;
                }

                if (this.dealCount >= 5 || this.stock.length === 0) {
                    this.showMessage('æ²¡æœ‰æ›´å¤šç‰Œäº†');
                    return;
                }

                this.saveState();

                for (let col = 0; col < 10; col++) {
                    if (this.stock.length > 0) {
                        const card = this.stock.pop();
                        card.faceUp = true;
                        this.columns[col].push(card);
                    }
                }

                this.dealCount++;
                this.render();

                this.checkSequences();
                this.updateStockPileState();
                this.checkDeadlock();
            }

            /**
             * æ¸²æŸ“æ¸¸æˆç•Œé¢
             */
            render() {
                this.renderColumns();
                this.renderFoundation();
                this.renderStockPile();
            }

            /**
             * æ¸²æŸ“10åˆ—ç‰Œ
             */
            renderColumns() {
                const board = document.getElementById('gameBoard');
                if (!board) return;
                board.innerHTML = '';

                this.columns.forEach((column, colIndex) => {
                    const colEl = document.createElement('div');
                    colEl.className = 'column';
                    colEl.dataset.colIndex = colIndex;

                    column.forEach((card, cardIndex) => {
                        const cardEl = this.createCardElement(card);
                        cardEl.style.top = `${cardIndex * 30}px`;
                        cardEl.style.zIndex = cardIndex;
                        colEl.appendChild(cardEl);
                    });

                    // å¦‚æœåˆ—ä¸ºç©ºï¼Œæ·»åŠ è™šçº¿æ¡†å ä½ç¬¦
                    if (column.length === 0) {
                        const placeholder = document.createElement('div');
                        placeholder.className = 'column-placeholder';
                        placeholder.style.cssText = 'width:100px;height:145px;border:2px dashed rgba(255,255,255,0.3);border-radius:8px;position:absolute;top:0;left:0;';
                        colEl.appendChild(placeholder);
                    }

                    board.appendChild(colEl);
                });
            }

            /**
             * åˆ›å»ºçº¸ç‰ŒDOMå…ƒç´ 
             */
            createCardElement(card) {
                const cardEl = document.createElement('div');
                cardEl.className = `card ${card.faceUp ? 'face-up' : 'face-down'}`;
                cardEl.dataset.cardId = card.id;

                if (card.faceUp) {
                    cardEl.innerHTML = `
                        <div class="card-face">
                            <div class="card-corner top">
                                <span class="card-rank">${card.rankDisplay}</span>
                                <span class="card-suit-small">${card.suit}</span>
                            </div>
                            <div class="card-center">${card.suit}</div>
                            <div class="card-corner bottom">
                                <span class="card-rank">${card.rankDisplay}</span>
                                <span class="card-suit-small">${card.suit}</span>
                            </div>
                        </div>
                        <div class="card-back"></div>
                    `;
                } else {
                    cardEl.innerHTML = `<div class="card-back"></div>`;
                }

                return cardEl;
            }

            /**
             * æ¸²æŸ“å›æ”¶åŒº
             * 1ä¸ªslotï¼Œ8ç»„ç‰Œæ°´å¹³å æ”¾æ˜¾ç¤º
             */
            renderFoundation() {
                const slots = document.querySelectorAll('.foundation-slot');
                const slot = slots[0];
                const completedCount = this.foundation.length;

                slot.innerHTML = '';
                slot.classList.add('completed');

                for (let i = 0; i < completedCount; i++) {
                    const card = this.foundation[i][0];
                    const cardEl = this.createCardElement(card);
                    cardEl.style.position = 'absolute';
                    cardEl.style.top = '10px';
                    cardEl.style.left = `${i * 35}px`;
                    slot.appendChild(cardEl);
                }
            }

            /**
             * æ¸²æŸ“å‘ç‰ŒåŒº
             */
            renderStockPile() {
                const stockPile = document.getElementById('stockPile');

                if (this.stock.length === 0) {
                    // ä¿ç•™å ä½å…ƒç´ ï¼Œé¿å…åç»­æ“ä½œå‡ºé”™
                    stockPile.innerHTML = `
                        <div class="card" style="opacity: 0.3;">
                            <div class="card-back"></div>
                        </div>
                        <span class="stock-count" id="stockCount">0</span>
                    `;
                    stockPile.classList.add('disabled');
                } else {
                    // æ˜¾ç¤ºèƒŒé¢ç‰Œ
                    stockPile.innerHTML = `
                        <div class="card">
                            <div class="card-back"></div>
                        </div>
                        <span class="stock-count" id="stockCount">${this.stock.length}</span>
                    `;
                    this.updateStockPileState();
                }
            }

            /**
             * æ›´æ–°å‘ç‰ŒåŒºçŠ¶æ€ï¼ˆæ˜¯å¦å¯ç”¨ï¼‰
             */
            updateStockPileState() {
                const stockPile = document.getElementById('stockPile');
                const canDeal = this.columns.every(col => 
                    col.length > 0 && col.some(card => card.faceUp)
                );

                if (canDeal && this.stock.length > 0) {
                    stockPile.classList.remove('disabled');
                } else {
                    stockPile.classList.add('disabled');
                }
            }

            /**
             * ç»‘å®šäº‹ä»¶
             */
            bindEvents() {
                document.getElementById('stockPile').addEventListener('click', () => {
                    if (!document.getElementById('stockPile').classList.contains('disabled')) {
                        this.dealCards();
                    }
                });

                document.getElementById('gameBoard').addEventListener('mousedown', (e) => {
                    this.handleMouseDown(e);
                });

                document.getElementById('gameBoard').addEventListener('click', (e) => {
                    this.handleColumnClick(e);
                });

                document.addEventListener('mousemove', (e) => {
                    this.handleMouseMove(e);
                });

                document.addEventListener('mouseup', (e) => {
                    this.handleMouseUp(e);
                });

                document.getElementById('hintBtn').addEventListener('click', () => {
                    this.showHint();
                });

                document.getElementById('undoBtn').addEventListener('click', () => {
                    this.undo();
                });

                document.getElementById('restartBtn').addEventListener('click', () => {
                    this.restart();
                });

                document.getElementById('deadlockUndoBtn').addEventListener('click', () => {
                    this.undo();
                });
            }

            /**
             * å¤„ç†é¼ æ ‡æŒ‰ä¸‹
             */
            handleMouseDown(e) {
                const cardEl = e.target.closest('.card');
                if (!cardEl) return;

                const column = cardEl.closest('.column');
                const colIndex = parseInt(column.dataset.colIndex);
                const cardId = cardEl.dataset.cardId;
                const columnCards = this.columns[colIndex];

                let cardIndex = columnCards.findIndex(c => c.id === cardId);
                if (cardIndex === -1) return;

                const card = columnCards[cardIndex];

                if (!card.faceUp) {
                    return;
                }

                if (this.isValidDrag(columnCards, cardIndex)) {
                    this.startDrag(e, colIndex, cardIndex);
                }
            }

            /**
             * ç¿»å¼€ç‰Œï¼ˆç‚¹å‡»èƒŒé¢ç‰Œæ—¶ï¼‰
             */
            flipCard(colIndex) {
                const column = this.columns[colIndex];
                // æ‰¾åˆ°æœ€ä¸Šé¢çš„èƒŒé¢ç‰Œ
                for (let i = column.length - 1; i >= 0; i--) {
                    if (!column[i].faceUp) {
                        column[i].faceUp = true;
                        this.render();
                        this.checkSequences();
                        return;
                    }
                }
            }

            /**
             * æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‹–åŠ¨ï¼šå¿…é¡»æ˜¯æ­£é¢æœä¸Šçš„è¿ç»­åŒèŠ±è‰²é€’å‡åºåˆ—
             */
            isValidDrag(columnCards, cardIndex) {
                // é€‰ä¸­çš„ç‰Œå¿…é¡»æ˜¯æ­£é¢æœä¸Šçš„
                if (!columnCards[cardIndex].faceUp) return false;

                // æ£€æŸ¥ä»é€‰ä¸­ç‰Œå¼€å§‹æ˜¯å¦æ˜¯è¿ç»­çš„é€’å‡åºåˆ—
                for (let i = cardIndex; i < columnCards.length - 1; i++) {
                    const current = columnCards[i];
                    const next = columnCards[i + 1];

                    // å¿…é¡»åŒèŠ±è‰²ä¸”ç‚¹æ•°é€’å‡1
                    if (current.suit !== next.suit || current.rank !== next.rank + 1) {
                        return false;
                    }
                }

                return true;
            }

            /**
             * å¼€å§‹æ‹–æ‹½
             */
            startDrag(e, colIndex, cardIndex) {
                this.clearHint();
                this.clearClickSelection();

                const column = this.columns[colIndex];
                const cards = column.slice(cardIndex);
                const cardEls = e.target.closest('.column').querySelectorAll('.card');
                
                this.dragState = {
                    colIndex,
                    cardIndex,
                    cards,
                    cardEls: Array.from(cardEls).slice(cardIndex),
                    startX: e.clientX,
                    startY: e.clientY,
                    initialPositions: [],
                    offsetX: 0,
                    offsetY: 0
                };

                this.dragState.cardEls.forEach(el => {
                    this.dragState.initialPositions.push({
                        left: el.offsetLeft,
                        top: el.offsetTop
                    });
                });

                this.selectedCard = { colIndex, cardIndex };
                this.highlightSelected(cards);

                this.dragState.cardEls.forEach(el => el.classList.add('dragging'));
            }

            /**
             * å¤„ç†é¼ æ ‡ç§»åŠ¨
             */
            handleMouseMove(e) {
                if (!this.dragState) return;

                const dx = e.clientX - this.dragState.startX;
                const dy = e.clientY - this.dragState.startY;

                this.dragState.offsetX = dx;
                this.dragState.offsetY = dy;

                // æ›´æ–°æ‹–æ‹½ç‰Œçš„ä½ç½®
                this.dragState.cardEls.forEach((el, index) => {
                    const pos = this.dragState.initialPositions[index];
                    el.style.left = `${pos.left + dx}px`;
                    el.style.top = `${pos.top + dy}px`;
                });

                // é«˜äº®å¯æ”¾ç½®çš„ç›®æ ‡
                this.highlightDropTarget(e.clientX, e.clientY);
            }

            /**
             * é«˜äº®æ‹–åŠ¨çš„ç‰Œ
             */
            highlightSelected(cards) {
                // æ¸…é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.card.selected').forEach(el => {
                    el.classList.remove('selected');
                });

                // é€‰ä¸­å½“å‰æ‹–åŠ¨çš„ç‰Œ
                cards.forEach(card => {
                    const el = document.querySelector(`[data-card-id="${card.id}"]`);
                    if (el) el.classList.add('selected');
                });
            }

            /**
             * é«˜äº®å¯æ”¾ç½®çš„ç›®æ ‡
             */
            highlightDropTarget(mouseX, mouseY) {
                // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
                document.querySelectorAll('.card.drop-target').forEach(el => {
                    el.classList.remove('drop-target');
                });

                // æ‰¾åˆ°é¼ æ ‡ä¸‹çš„ç‰Œ
                const targetCard = this.getCardAtPosition(mouseX, mouseY);
                if (targetCard) {
                    const el = document.querySelector(`[data-card-id="${targetCard.id}"]`);
                    if (el) el.classList.add('drop-target');
                }
            }

            /**
             * è·å–æŒ‡å®šä½ç½®çš„ç‰Œ
             */
            getCardAtPosition(x, y) {
                const elements = document.elementsFromPoint(x, y);
                for (const el of elements) {
                    if (el.classList.contains('card') && el.classList.contains('face-up')) {
                        const cardId = el.dataset.cardId;
                        // åœ¨æ‰€æœ‰åˆ—ä¸­æŸ¥æ‰¾
                        for (const column of this.columns) {
                            const card = column.find(c => c.id === cardId);
                            if (card) return card;
                        }
                    }
                }
                return null;
            }

            /**
             * å¤„ç†é¼ æ ‡æ¾å¼€
             */
            handleMouseUp(e) {
                if (!this.dragState) return;

                this.clearHint();

                this.dragState.cardEls.forEach(el => {
                    el.classList.remove('dragging');
                    el.classList.remove('drop-target');
                });

                const targetCard = this.getCardAtPosition(e.clientX, e.clientY);
                const placed = this.tryPlaceCard(targetCard);

                if (!placed) {
                    this.dragState.cardEls.forEach((el, index) => {
                        const pos = this.dragState.initialPositions[index];
                        el.style.left = `${pos.left}px`;
                        el.style.top = `${pos.top}px`;
                    });
                }

                this.dragState = null;
                this.selectedCard = null;
                this.clearHighlights();
            }

            /**
             * å¤„ç†åˆ—çš„ç‚¹å‡»ï¼ˆç‚¹å‡»ç§»åŠ¨é€»è¾‘ï¼‰
             */
            handleColumnClick(e) {
                if (this.dragState) return;

                const column = e.target.closest('.column');
                if (!column) {
                    this.clearClickSelection();
                    return;
                }

                const colIndex = parseInt(column.dataset.colIndex);

                const columnCards = this.columns[colIndex];
                if (columnCards.length === 0) {
                    this.clearClickSelection();
                    return;
                }

                const cardEl = e.target.closest('.card');
                if (!cardEl) {
                    this.clearClickSelection();
                    return;
                }

                const cardId = cardEl.dataset.cardId;
                const cardIndex = columnCards.findIndex(c => c.id === cardId);
                if (cardIndex === -1) {
                    this.clearClickSelection();
                    return;
                }

                const card = columnCards[cardIndex];

                if (!card.faceUp) {
                    this.clearClickSelection();
                    return;
                }

                if (this.clickSelection.colIndex !== null) {
                    const { colIndex: fromColIndex, cardIndex: fromCardIndex, cards } = this.clickSelection;
                    const firstCard = cards[0];

                    if (fromColIndex === colIndex) {
                        this.clearClickSelection();
                        return;
                    }

                    const targetColumn = this.columns[colIndex];

                    if (targetColumn.length === 0) {
                        this.moveCards(fromColIndex, fromCardIndex, colIndex);
                        this.clearClickSelection();
                        return;
                    } else {
                        const topCard = targetColumn[targetColumn.length - 1];
                        if (topCard.faceUp && topCard.suit === firstCard.suit && topCard.rank === firstCard.rank + 1) {
                            this.moveCards(fromColIndex, fromCardIndex, colIndex);
                            this.clearClickSelection();
                            return;
                        } else {
                            this.showMessage('æ— æ³•ç§»åŠ¨åˆ°è¯¥ä½ç½®');
                            this.shakeCard(cardEl);
                            this.clearClickSelection();
                            return;
                        }
                    }
                }

                if (!this.isValidDrag(columnCards, cardIndex)) {
                    this.showMessage('åªèƒ½ç§»åŠ¨è¿ç»­åŒèŠ±è‰²é€’å‡åºåˆ—');
                    return;
                }

                this.selectCards(colIndex, cardIndex);
            }

            /**
             * é€‰ä¸­ç‰Œç»„ï¼ˆç‚¹å‡»ç§»åŠ¨ï¼‰
             * é€‰ä¸­ç‚¹å‡»çš„ç‰ŒåŠå…¶ä¸Šæ–¹æ‰€æœ‰è¿ç»­çš„åŒèŠ±è‰²é€’å‡åºåˆ—
             */
            selectCards(colIndex, cardIndex) {
                this.clearClickSelection();

                const column = this.columns[colIndex];

                // ä»ç‚¹å‡»ä½ç½®å‘ä¸ŠæŸ¥æ‰¾è¿ç»­çš„åŒèŠ±è‰²é€’å‡åºåˆ—
                let startIndex = cardIndex;
                for (let i = cardIndex; i > 0; i--) {
                    const current = column[i];
                    const above = column[i - 1];
                    if (above.faceUp && above.suit === current.suit && above.rank === current.rank + 1) {
                        startIndex = i - 1;
                    } else {
                        break;
                    }
                }

                const cards = column.slice(startIndex);

                this.clickSelection = {
                    colIndex,
                    cardIndex: startIndex,
                    cards,
                    validTargets: this.findValidTargets(colIndex, cards)
                };

                this.highlightClickSelection();
            }

            /**
             * æ¸…é™¤ç‚¹å‡»é€‰ä¸­çŠ¶æ€
             */
            clearClickSelection() {
                this.clickSelection = {
                    colIndex: null,
                    cardIndex: null,
                    cards: [],
                    validTargets: []
                };
                document.querySelectorAll('.card.click-selected').forEach(el => {
                    el.classList.remove('click-selected');
                });
                document.querySelectorAll('.column.valid-target').forEach(el => {
                    el.classList.remove('valid-target');
                });
            }

            /**
             * é«˜äº®ç‚¹å‡»é€‰ä¸­çš„ç‰Œå’Œæœ‰æ•ˆç›®æ ‡åˆ—
             */
            highlightClickSelection() {
                const { cards, validTargets } = this.clickSelection;

                cards.forEach(card => {
                    const el = document.querySelector(`[data-card-id="${card.id}"]`);
                    if (el) el.classList.add('click-selected');
                });

                validTargets.forEach(colIndex => {
                    const colEl = document.querySelector(`.column[data-col-index="${colIndex}"]`);
                    if (colEl) colEl.classList.add('valid-target');
                });
            }

            /**
             * å¡ç‰‡æ™ƒåŠ¨åŠ¨ç”»ï¼ˆæ— æ•ˆç§»åŠ¨åé¦ˆï¼‰
             */
            shakeCard(cardEl) {
                if (!cardEl) return;
                cardEl.classList.add('invalid-move');
                setTimeout(() => {
                    cardEl.classList.remove('invalid-move');
                }, 300);
            }

            /**
             * æŸ¥æ‰¾æœ‰æ•ˆçš„æ”¾ç½®ç›®æ ‡åˆ—
             */
            findValidTargets(fromColIndex, cards) {
                const validTargets = [];
                const firstCard = cards[0];

                for (let colIndex = 0; colIndex < this.columns.length; colIndex++) {
                    if (colIndex === fromColIndex) continue;

                    const targetColumn = this.columns[colIndex];

                    if (targetColumn.length === 0) {
                        validTargets.push(colIndex);
                    } else {
                        const topCard = targetColumn[targetColumn.length - 1];
                        if (topCard.faceUp && topCard.suit === firstCard.suit && topCard.rank === firstCard.rank + 1) {
                            validTargets.push(colIndex);
                        }
                    }
                }

                return validTargets;
            }

            /**
             * å¤„ç†ç‚¹å‡»ç§»åŠ¨åˆ°ç›®æ ‡åˆ—
             */
            executeClickMove(targetColIndex) {
                const { colIndex, cardIndex, cards } = this.clickSelection;

                if (!this.clickSelection.validTargets.includes(targetColIndex)) {
                    return false;
                }

                this.moveCards(colIndex, cardIndex, targetColIndex);
                this.clearClickSelection();
                return true;
            }

            /**
             * å°è¯•æ”¾ç½®ç‰Œç»„
             */
            tryPlaceCard(targetCard) {
                const { colIndex, cardIndex, cards, startX, startY, offsetX, offsetY } = this.dragState;
                const mouseX = startX + offsetX;
                const mouseY = startY + offsetY;

                // æ‰¾åˆ°é¼ æ ‡ä¸‹çš„åˆ—
                let targetColIndex = -1;
                const columns = document.querySelectorAll('.column');

                for (let i = 0; i < columns.length; i++) {
                    const rect = columns[i].getBoundingClientRect();
                    if (mouseX >= rect.left && mouseX <= rect.right) {
                        targetColIndex = i;
                        break;
                    }
                }

                if (targetColIndex === -1) return false;
                if (targetColIndex === colIndex) return false;

                const targetColumn = this.columns[targetColIndex];
                const firstCard = cards[0];

                // ç©ºåˆ—ï¼šå¯ä»¥æ”¾ä»»æ„ç‰Œ
                if (targetColumn.length === 0) {
                    this.moveCards(colIndex, cardIndex, targetColIndex);
                    return true;
                }

                // éç©ºåˆ—ï¼šæ£€æŸ¥æ˜¯å¦å¯ä»¥æ”¾ç½®ï¼ˆç›®æ ‡åˆ—é¡¶éƒ¨ç‰Œç‚¹æ•°å¤§1ï¼ŒåŒèŠ±è‰²ï¼‰
                const topCard = targetColumn[targetColumn.length - 1];
                if (topCard.faceUp && topCard.suit === firstCard.suit && topCard.rank === firstCard.rank + 1) {
                    this.moveCards(colIndex, cardIndex, targetColIndex);
                    return true;
                }

                return false;
            }

            /**
             * ç§»åŠ¨ç‰Œç»„
             */
            moveCards(fromColIndex, fromCardIndex, toColIndex) {
                this.saveState();

                const cards = this.columns[fromColIndex].splice(fromCardIndex);
                this.columns[toColIndex].push(...cards);

                const fromColumn = this.columns[fromColIndex];
                if (fromColumn.length > 0) {
                    const topCard = fromColumn[fromColumn.length - 1];
                    if (!topCard.faceUp) {
                        topCard.faceUp = true;
                    }
                }

                this.render();
                this.checkSequences();
                this.updateStockPileState();
                this.checkDeadlock();
            }

            /**
             * æ£€æµ‹ç‰Œæ˜¯å¦è¿ç»­é€’å‡ï¼ˆåŒèŠ±è‰²ï¼‰
             * columnæ•°ç»„ï¼šcolumn[0]æ˜¯é¡¶éƒ¨ï¼Œcolumn[length-1]æ˜¯åº•éƒ¨
             * åºåˆ—ï¼šcolumn[length-13] = K, ..., column[length-1] = A
             * æ‰€ä»¥åº”è¯¥ä» A çš„ä½ç½®ï¼ˆlength-1ï¼‰å‘å‰æ£€æŸ¥13å¼ ç‰Œ
             */
            isValidSequence(column, startIndex) {
                // startIndex æ˜¯ A çš„ä½ç½®ï¼Œéœ€è¦å‘å‰æ£€æŸ¥13å¼ ç‰Œ
                // å¿…é¡»ç¡®ä¿ startIndex - 12 >= 0
                if (startIndex < 12) return false;
                
                const suit = column[startIndex].suit;

                // æ£€æŸ¥13å¼ ç‰Œï¼šcolumn[startIndex] = A(1), column[startIndex-1] = 2, ..., column[startIndex-12] = K(13)
                for (let j = 0; j < 13; j++) {
                    const pos = startIndex - j;
                    const card = column[pos];
                    const expectedRank = 1 + j;
                    
                    if (!card) return false;
                    if (card.suit !== suit || card.rank !== expectedRank || !card.faceUp) {
                        return false;
                    }
                }
                return true;
            }

            /**
             * æ£€æŸ¥æ˜¯å¦å½¢æˆK-Aåºåˆ—å¹¶å›æ”¶
             * è§„åˆ™ï¼šåºåˆ—åœ¨åˆ—çš„ä¸‹æ–¹å³å¯ï¼Œä¸Šé¢æœ‰æ²¡æœ‰ç‰Œæ— æ‰€è°“
             * æ³¨æ„ï¼šcolumn[0]æ˜¯é¡¶éƒ¨ï¼Œcolumn[length-1]æ˜¯åº•éƒ¨
             */
            checkSequences() {
                let foundSequence = false;

                for (let colIndex = 0; colIndex < this.columns.length; colIndex++) {
                    const column = this.columns[colIndex];
                    if (column.length < 13) continue;

                    // åªæ£€æŸ¥æœ€ä¸‹é¢çš„13å¼ ç‰Œï¼ˆå¯èƒ½å½¢æˆåºåˆ—çš„åŒºåŸŸï¼‰
                    for (let i = column.length - 13; i < column.length; i++) {
                        if (column[i].rank !== 1) continue;
                        
                        if (this.isValidSequence(column, i)) {
                            // ç§»é™¤13å¼ ç‰Œ
                            const sequence = [];
                            for (let k = 0; k < 13; k++) {
                                sequence.push(column.pop());
                            }
                            sequence.reverse();

                            this.foundation.push(sequence);
                            this.completedCount++;
                            foundSequence = true;

                            // è‡ªåŠ¨ç¿»å¼€åºåˆ—ä¸Šæ–¹çš„é‚£å¼ ç‰Œï¼ˆå¦‚æœæœ‰ï¼‰
                            // åºåˆ—ä» i-12(K) åˆ° i(A)ï¼Œæ‰€ä»¥ä¸Šæ–¹æ˜¯ i-13
                            if (i >= 13) {
                                const cardAbove = column[i - 13];
                                if (cardAbove && !cardAbove.faceUp) {
                                    cardAbove.faceUp = true;
                                }
                            }
                            break;
                        }
                    }
                }

                if (foundSequence) {
                    this.renderColumns();
                    this.renderFoundation();
                    this.renderStockPile();
                    
                    if (this.completedCount >= 8) {
                        this.stopTimer();
                        document.getElementById('winTime').textContent = `ç”¨æ—¶ï¼š${this.getElapsedTime()}`;
                        document.getElementById('winModal').classList.add('show');
                    }
                    this.checkSequences();
                }
            }

            /**
             * æ¸…é™¤é«˜äº®
             */
            clearHighlights() {
                document.querySelectorAll('.card.selected, .card.drop-target').forEach(el => {
                    el.classList.remove('selected', 'drop-target');
                });
                this.clearClickSelection();
            }

            /**
             * æ˜¾ç¤ºæç¤ºä¿¡æ¯
             */
            showMessage(text) {
                const msg = document.getElementById('message');
                msg.textContent = text;
                msg.classList.add('show');
                setTimeout(() => msg.classList.remove('show'), 2000);
            }

            /**
             * ä¿å­˜å½“å‰çŠ¶æ€ï¼ˆç”¨äºæ’¤é”€ï¼‰
             */
            saveState() {
                if (this.undoCount <= 0) return;
                this.lastState = {
                    columns: this.columns.map(col => col.map(c => ({...c}))),
                    stock: this.stock.map(c => ({...c})),
                    foundation: this.foundation.map(seq => seq.map(c => ({...c}))),
                    completedCount: this.completedCount,
                    dealCount: this.dealCount
                };
            }

            /**
             * æ’¤é”€ä¸Šä¸€æ­¥
             */
            undo() {
                if (!this.lastState || this.undoCount <= 0) return;
                this.columns = this.lastState.columns.map(col => col.map(c => ({...c})));
                this.stock = this.lastState.stock.map(c => ({...c}));
                this.foundation = this.lastState.foundation.map(seq => seq.map(c => ({...c})));
                this.completedCount = this.lastState.completedCount;
                this.dealCount = this.lastState.dealCount;
                this.lastState = null;
                this.undoCount--;
                this.render();
                this.updateToolbar();
                document.getElementById('deadlockModal').classList.remove('show');
            }

            /**
             * æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„ç§»åŠ¨
             */
            findPossibleMoves() {
                const moves = [];

                for (let fromCol = 0; fromCol < 10; fromCol++) {
                    const column = this.columns[fromCol];
                    if (column.length === 0) continue;

                    for (let cardIndex = 0; cardIndex < column.length; cardIndex++) {
                        const card = column[cardIndex];
                        if (!card.faceUp) continue;

                        if (!this.isValidDrag(column, cardIndex)) continue;

                        const dragCards = column.slice(cardIndex);

                        for (let toCol = 0; toCol < 10; toCol++) {
                            if (toCol === fromCol) continue;

                            const targetColumn = this.columns[toCol];

                            if (targetColumn.length === 0) {
                                moves.push({
                                    fromCol,
                                    cardIndex,
                                    toCol,
                                    score: 20 + dragCards.length * 2,
                                    reason: 'ç©ºåˆ—'
                                });
                            } else {
                                const topCard = targetColumn[targetColumn.length - 1];
                                if (topCard.faceUp && topCard.suit === card.suit && topCard.rank === card.rank + 1) {
                                    let score = dragCards.length * 2;

                                    const newCol = [...targetColumn, ...dragCards];
                                    if (newCol.length >= 13) {
                                        for (let i = newCol.length - 13; i < newCol.length; i++) {
                                            if (newCol[i].rank === 1 && this.isValidSequence(newCol, i)) {
                                                score += 50;
                                                break;
                                            }
                                        }
                                    }

                                    moves.push({
                                        fromCol,
                                        cardIndex,
                                        toCol,
                                        score,
                                        reason: 'æ™®é€šç§»åŠ¨'
                                    });
                                }
                            }
                        }
                    }
                }

                return moves.sort((a, b) => b.score - a.score);
            }

            /**
             * æ˜¾ç¤ºæç¤º
             */
            showHint() {
                if (this.hintCount <= 0) {
                    this.showMessage('æç¤ºæ¬¡æ•°å·²ç”¨å®Œ');
                    return;
                }

                const moves = this.findPossibleMoves();
                if (moves.length === 0) {
                    this.showMessage('æ²¡æœ‰å¯ç”¨çš„ç§»åŠ¨');
                    return;
                }

                this.hintCount--;
                this.updateToolbar();

                const bestMove = moves[0];
                const cards = this.columns[bestMove.fromCol].slice(bestMove.cardIndex);
                const targetCol = this.columns[bestMove.toCol];

                this.clearHint();

                cards.forEach(card => {
                    const el = document.querySelector(`[data-card-id="${card.id}"]`);
                    if (el) {
                        el.classList.add('hint-highlight');
                        this.hintElements.push(el);
                    }
                });

                if (targetCol.length > 0) {
                    const topCard = targetCol[targetCol.length - 1];
                    const targetEl = document.querySelector(`[data-card-id="${topCard.id}"]`);
                    if (targetEl) {
                        targetEl.classList.add('hint-highlight');
                        this.hintElements.push(targetEl);
                    }
                }

                setTimeout(() => this.clearHint(), 3000);
                this.showMessage('å»ºè®®ç§»åŠ¨å·²é«˜äº®æ˜¾ç¤º');
            }

            /**
             * æ¸…é™¤æç¤ºé«˜äº®
             */
            clearHint() {
                this.hintElements.forEach(el => el.classList.remove('hint-highlight'));
                this.hintElements = [];
            }

            /**
             * æ£€æµ‹æ˜¯å¦æœ‰ä»»ä½•åˆæ³•ç§»åŠ¨
             */
            hasAnyValidMove() {
                const moves = this.findPossibleMoves();
                return moves.length > 0;
            }

            /**
             * æ£€æµ‹æ­»é”çŠ¶æ€
             */
            checkDeadlock() {
                if (this.stock.length > 0) return false;
                if (this.completedCount >= 8) return false;
                if (this.hasAnyValidMove()) return false;

                document.getElementById('deadlockModal').classList.add('show');
                return true;
            }

            /**
             * æ›´æ–°å·¥å…·æ çŠ¶æ€
             */
            updateToolbar() {
                const hintBtn = document.getElementById('hintBtn');
                const undoBtn = document.getElementById('undoBtn');

                if (hintBtn) {
                    hintBtn.textContent = `ğŸ’¡ æç¤º (${this.hintCount})`;
                    hintBtn.disabled = this.hintCount <= 0;
                }

                if (undoBtn) {
                    undoBtn.textContent = `â†©ï¸ æ’¤é”€ (${this.undoCount})`;
                    undoBtn.disabled = this.undoCount <= 0 || !this.lastState;
                }
            }

            /**
             * é‡æ–°å¼€å§‹æ¸¸æˆ
             */
            restart() {
                document.getElementById('winModal').classList.remove('show');
                document.getElementById('deadlockModal').classList.remove('show');
                this.stopTimer();
                this.columns = [];
                this.stock = [];
                this.foundation = [];
                this.dragState = null;
                this.selectedCard = null;
                this.completedCount = 0;
                this.dealCount = 0;
                this.undoCount = 3;
                this.hintCount = 3;
                this.lastState = null;
                this.clearHint();

                this.createDeck();
                this.shuffleDeck();
                this.dealInitialCards();
                this.render();
                this.startTimer();
                this.updateToolbar();
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        const game = new SpiderSolitaire();
    </script>
</body>
</html>
