<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>èœ˜è››çº¸ç‰Œ - å•èŠ±è‰²</title>
    <style>
        :root {
            --scale: 1;
            --card-width: 100px;
            --card-height: 145px;
            --column-width: 100px;
            --card-offset: 30px;
            --font-size-base: 1;
        }

        @media (max-width: 1200px) {
            :root { --scale: 0.9; --card-width: 90px; --card-height: 130px; --column-width: 90px; --card-offset: 27px; }
        }
        @media (max-width: 992px) {
            :root { --scale: 0.8; --card-width: 80px; --card-height: 116px; --column-width: 80px; --card-offset: 24px; }
        }
        @media (max-width: 768px) {
            :root { --scale: 0.7; --card-width: 70px; --card-height: 101px; --column-width: 70px; --card-offset: 21px; }
        }
        @media (max-width: 576px) {
            :root { --scale: 0.6; --card-width: 60px; --card-height: 87px; --column-width: 60px; --card-offset: 18px; }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #1a4d1a 0%, #0d330d 50%, #0a2a0a 100%);
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            overflow: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: calc(10px * var(--scale));
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: calc(5px * var(--scale)) calc(15px * var(--scale));
            margin-bottom: calc(5px * var(--scale));
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: calc(15px * var(--scale));
        }

        .timer {
            color: #fff;
            font-size: calc(14px * var(--scale));
            font-family: monospace;
            background: rgba(0,0,0,0.3);
            padding: calc(4px * var(--scale)) calc(10px * var(--scale));
            border-radius: 4px;
        }

        .toolbar-right {
            display: flex;
            gap: calc(8px * var(--scale));
        }

        .toolbar-btn {
            background: rgba(0,0,0,0.3);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
            padding: calc(4px * var(--scale)) calc(12px * var(--scale));
            font-size: calc(12px * var(--scale));
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toolbar-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.2);
        }

        .toolbar-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* æ¸¸æˆä¸»åŒºåŸŸï¼š10åˆ—ç‰Œ */
        .game-board {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: calc(8px * var(--scale));
            padding: 0 calc(20px * var(--scale));
            padding-top: calc(10px * var(--scale));
            touch-action: none;
        }

        .column {
            width: var(--column-width);
            min-height: calc(450px * var(--scale));
            position: relative;
            touch-action: none;
        }

        /* çº¸ç‰Œæ ·å¼ */
        .card {
            width: var(--card-width);
            height: var(--card-height);
            border-radius: 8px;
            position: absolute;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            touch-action: none;
            -webkit-touch-callout: none;
        }

        .card-face {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: calc(10px * var(--scale));
            background: #fff;
            border: 1px solid #ccc;
        }

        .card-back {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            background: linear-gradient(135deg, #2c5aa0 0%, #1e4080 50%, #1a3570 100%);
            border: 3px solid #fff;
            position: relative;
            overflow: hidden;
        }

        .card-back::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: calc(70px * var(--scale));
            height: calc(100px * var(--scale));
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(255, 255, 255, 0.05) 5px,
                rgba(255, 255, 255, 0.05) 10px
            );
        }

        .card.face-up .card-back {
            display: none;
        }

        .card.face-down .card-face {
            display: none;
        }

        .card-corner {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1;
        }

        .card-corner.top {
            align-self: flex-start;
        }

        .card-corner.bottom {
            align-self: flex-end;
            transform: rotate(180deg);
        }

        .card-rank {
            font-size: calc(22px * var(--scale));
            font-weight: bold;
            color: #000;
        }

        .card-suit-small {
            font-size: calc(16px * var(--scale));
            color: #000;
        }

        .card-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: calc(54px * var(--scale));
            color: #000;
        }

        .card.selected {
            box-shadow: 0 0 0 3px #ffd700, 0 8px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000 !important;
        }

        .card.dragging {
            transition: none;
            z-index: 1001 !important;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
            cursor: grabbing;
            will-change: left, top;
        }

        .card.invalid-move {
            animation: shake 0.3s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .card.hint-highlight {
            animation: hintPulse 0.8s ease infinite;
        }

        @keyframes hintPulse {
            0%, 100% { box-shadow: 0 0 0 3px #ffd700; }
            50% { box-shadow: 0 0 15px 5px #ffd700; }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        .card.fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card.flip {
            animation: flipIn 0.3s ease;
        }

        @keyframes flipIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        /* åº•éƒ¨åŒºåŸŸï¼šå›æ”¶åŒºå’Œå‘ç‰ŒåŒº */
        .bottom-area {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: calc(140px * var(--scale));
            padding: calc(10px * var(--scale)) calc(20px * var(--scale));
        }

        /* å›æ”¶åŒº - å·¦ä¸‹è§’ */
        .foundation {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: calc(10px * var(--scale));
        }

        .foundation-slot {
            min-width: calc(350px * var(--scale));
            width: auto;
            height: calc(130px * var(--scale));
            border-radius: 8px;
            position: relative;
        }

        .foundation-slot.completed {
            border: none;
            background: transparent;
        }

        .foundation-slot .card {
            width: calc(80px * var(--scale));
            height: calc(110px * var(--scale));
            position: absolute;
        }

        .foundation-slot .card .card-face {
            padding: calc(5px * var(--scale));
        }

        .foundation-slot .card .card-corner .card-rank {
            font-size: calc(16px * var(--scale));
        }

        .foundation-slot .card .card-corner .card-suit-small {
            font-size: calc(12px * var(--scale));
        }

        .foundation-slot .card .card-center {
            font-size: calc(36px * var(--scale));
        }

        /* å‘ç‰ŒåŒº - å³ä¸‹è§’ */
        .stock-area {
            display: flex;
            align-items: center;
            gap: calc(10px * var(--scale));
            padding: calc(10px * var(--scale));
            background: rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .stock-pile {
            width: calc(100px * var(--scale));
            height: calc(145px * var(--scale));
            position: relative;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .stock-pile.disabled {
            cursor: not-allowed;
            opacity: 0.4;
        }

        .stock-pile:not(.disabled):hover {
            transform: scale(1.05);
        }

        .stock-count {
            position: absolute;
            bottom: calc(-25px * var(--scale));
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            font-size: calc(14px * var(--scale));
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        /* èƒœåˆ©å¼¹çª— */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: linear-gradient(135deg, #2d5016 0%, #1a3009 100%);
            padding: calc(40px * var(--scale)) calc(60px * var(--scale));
            border-radius: 15px;
            text-align: center;
            border: 3px solid #4a7c23;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-title {
            color: #ffd700;
            font-size: calc(36px * var(--scale));
            margin-bottom: calc(20px * var(--scale));
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .modal-btn {
            background: linear-gradient(135deg, #4a7c23 0%, #3d6a1c 100%);
            color: #fff;
            border: 2px solid #6ba332;
            padding: calc(12px * var(--scale)) calc(40px * var(--scale));
            font-size: calc(18px * var(--scale));
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: calc(20px * var(--scale));
        }

        .modal-btn:hover {
            background: linear-gradient(135deg, #5a8c33 0%, #4d7a2c 100%);
            transform: scale(1.05);
        }

        /* æç¤ºä¿¡æ¯ */
        .message {
            position: fixed;
            top: calc(20px * var(--scale));
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: calc(10px * var(--scale)) calc(20px * var(--scale));
            border-radius: 5px;
            font-size: calc(14px * var(--scale));
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1500;
        }

        .message.show {
            opacity: 1;
        }

        .modal-content.small {
            padding: calc(25px * var(--scale)) calc(40px * var(--scale));
        }

        .modal-content.small .modal-title {
            font-size: calc(24px * var(--scale));
            margin-bottom: calc(10px * var(--scale));
        }

        .modal-content.small .modal-text {
            color: #fff;
            font-size: calc(14px * var(--scale));
            margin-bottom: calc(20px * var(--scale));
        }

        .modal-btn.small {
            padding: calc(8px * var(--scale)) calc(20px * var(--scale));
            font-size: calc(14px * var(--scale));
            margin: 0 calc(5px * var(--scale));
        }

        /* æ¨ªå±æç¤ºè¦†ç›–å±‚ */
        .orientation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a4d1a 0%, #0d330d 50%, #0a2a0a 100%);
            justify-content: center;
            align-items: center;
            z-index: 3000;
            flex-direction: column;
            gap: calc(30px * var(--scale));
        }

        .orientation-modal.show {
            display: flex;
        }

        .orientation-icon {
            font-size: calc(80px * var(--scale));
            animation: rotatePhone 1.5s ease-in-out infinite;
        }

        @keyframes rotatePhone {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(90deg); }
            75% { transform: rotate(90deg); }
        }

        .orientation-text {
            color: #fff;
            font-size: calc(20px * var(--scale));
            text-align: center;
            padding: 0 calc(20px * var(--scale));
        }

        .orientation-btns {
            display: flex;
            gap: calc(20px * var(--scale));
        }

        .orientation-btn {
            padding: calc(15px * var(--scale)) calc(30px * var(--scale));
            font-size: calc(16px * var(--scale));
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .orientation-btn.landscape {
            background: linear-gradient(135deg, #4a7c23 0%, #3d6a1c 100%);
            color: #fff;
            border: 2px solid #6ba332;
        }

        .orientation-btn.portrait {
            background: rgba(255,255,255,0.1);
            color: #aaa;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .orientation-btn:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="toolbar">
            <div class="toolbar-left">
                <span class="timer" id="timer">ç”¨æ—¶ï¼š0åˆ†0ç§’</span>
            </div>
            <div class="toolbar-right">
                <button class="toolbar-btn" id="restartBtn">ğŸ”„ é‡ç©</button>
            </div>
        </div>
        <!-- æ¸¸æˆä¸»åŒºåŸŸï¼š10åˆ—ç‰Œ -->
        <div class="game-board" id="gameBoard"></div>

            <!-- åº•éƒ¨åŒºåŸŸï¼šå›æ”¶åŒºå’Œå‘ç‰ŒåŒº -->
            <div class="bottom-area">
                <!-- å›æ”¶åŒºï¼š1ä¸ªslotï¼Œå †å æ˜¾ç¤º -->
                <div class="foundation">
                    <div class="foundation-slot" data-index="0"></div>
                </div>
            <!-- å‘ç‰ŒåŒº -->
            <div class="stock-area">
                <div class="stock-pile" id="stockPile">
                    <div class="card">
                        <div class="card-back"></div>
                    </div>
                    <span class="stock-count" id="stockCount">50</span>
                </div>
            </div>
        </div>
    </div>

    <!-- èƒœåˆ©å¼¹çª— -->
    <div class="modal" id="winModal">
        <div class="modal-content">
            <h1 class="modal-title">æ­å–œé€šå…³</h1>
            <p style="color: #fff; font-size: 18px;">withdong02@qq.com</p>
            <button class="modal-btn" onclick="game.restart()">å†æ¥ä¸€å±€</button>
        </div>
    </div>

    <!-- æ­»é”å¼¹çª— -->
    <div class="modal" id="deadlockModal">
        <div class="modal-content small">
            <h2 class="modal-title" style="color: #ff6b6b;">æ— æ³•ç§»åŠ¨</h2>
            <p class="modal-text">å‘ç‰ŒåŒºå·²å‘å®Œï¼Œä¸”æ²¡æœ‰å¯ç§»åŠ¨çš„ç‰Œç»„</p>
            <div>
                <button class="modal-btn small" onclick="game.restart()">ğŸ”„ é‡ç©</button>
            </div>
        </div>
    </div>

    <!-- æç¤ºä¿¡æ¯ -->
    <div class="message" id="message"></div>

    <!-- æ¨ªå±æç¤ºè¦†ç›–å±‚ -->
    <div class="orientation-modal" id="orientationModal">
        <div class="orientation-icon">ğŸ“±</div>
        <div class="orientation-text">å»ºè®®æ¨ªå±æ¸¸ç©ï¼Œ<br>ä½“éªŒæ›´ä½³ï¼</div>
        <div class="orientation-btns">
            <button class="orientation-btn landscape" id="rotateBtn">ğŸ”„ åˆ‡æ¢æ¨ªå±</button>
            <button class="orientation-btn portrait" id="keepPortraitBtn">ä¿æŒç«–å±</button>
        </div>
    </div>

    <script>
        /**
         * èœ˜è››çº¸ç‰Œæ¸¸æˆ - å•èŠ±è‰²ç‰ˆæœ¬
         * 
         * æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š
         * - cards: æ‰€æœ‰ç‰Œçš„æ•°ç»„ï¼Œæ¯å¼ ç‰ŒåŒ…å« suit, rank, faceUp, id
         * - columns: 10åˆ—ç‰Œç»„ï¼Œæ¯åˆ—æ˜¯ç‰Œçš„æ•°ç»„
         * - stock: å‘ç‰ŒåŒºçš„ç‰Œï¼ˆèƒŒé¢æœä¸Šï¼‰
         * - foundation: å›æ”¶åŒºï¼Œæ”¶é›†å®Œæˆçš„K-Aåºåˆ—
         * 
         * æ ¸å¿ƒé€»è¾‘ï¼š
         * 1. åˆå§‹åŒ–ï¼šç”Ÿæˆ8å¥—104å¼ ç‰Œï¼Œæ´—ç‰Œï¼Œå‘åˆå§‹54å¼ åˆ°10åˆ—
         * 2. æ‹–æ‹½ï¼šåªèƒ½æ‹–åŠ¨æ­£é¢æœä¸Šçš„è¿ç»­é€’å‡åºåˆ—
         * 3. æ”¾ç½®ï¼šç›®æ ‡ç‰Œå¿…é¡»ç‚¹æ•°å¤§1ï¼ˆ5â†’6ï¼‰ï¼Œç©ºåˆ—å¯æ”¾ä»»æ„ç‰Œ
         * 4. åºåˆ—æ£€æµ‹ï¼šå½¢æˆK-AåŒèŠ±è‰²åºåˆ—åç§»åˆ°å›æ”¶åŒº
         * 5. é€šå…³ï¼š8ç»„K-Aå®Œæˆåæ˜¾ç¤ºèƒœåˆ©
         */
        class SpiderSolitaire {
            constructor() {
                this.columns = [];
                this.stock = [];
                this.foundation = [];
                this.dragState = null;
                this.selectedCard = null;
                this.completedCount = 0;
                this.dealCount = 0;
                this.timerInterval = null;
                this.startTime = null;
                this.init();
            }

            /**
             * åˆå§‹åŒ–æ¸¸æˆ
             */
            init() {
                this.createDeck();
                this.shuffleDeck();
                this.dealInitialCards();
                this.render();
                this.bindEvents();
                this.startTimer();
                this.checkOrientation();
            }

            /**
             * åˆ›å»ºç‰Œç»„ï¼š8å¥—104å¼ é»‘æ¡ƒèŠ±è‰²
             */
            createDeck() {
                this.cards = [];
                const suits = ['â™ '];
                const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
                
                for (let set = 0; set < 8; set++) {
                    for (let rank = 0; rank < 13; rank++) {
                        this.cards.push({
                            id: `${set}-${rank}`,
                            suit: suits[0],
                            rank: rank + 1,
                            rankDisplay: ranks[rank],
                            faceUp: false,
                            setId: set
                        });
                    }
                }
            }

            /**
             * æ´—ç‰Œï¼šéšæœºæ‰“ä¹±ç‰Œåº
             */
            shuffleDeck() {
                for (let i = this.cards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.cards[i], this.cards[j]] = [this.cards[j], this.cards[i]];
                }
            }

            /**
             * åˆå§‹å‘ç‰Œï¼šå‰4åˆ—å„6å¼ ï¼Œå6åˆ—å„5å¼ ï¼Œå…±54å¼ 
             */
            dealInitialCards() {
                this.columns = Array(10).fill(null).map(() => []);
                
                for (let col = 0; col < 4; col++) {
                    for (let i = 0; i < 6; i++) {
                        const card = this.cards.pop();
                        if (i === 5) card.faceUp = true;
                        this.columns[col].push(card);
                    }
                }
                
                for (let col = 4; col < 10; col++) {
                    for (let i = 0; i < 5; i++) {
                        const card = this.cards.pop();
                        if (i === 4) card.faceUp = true;
                        this.columns[col].push(card);
                    }
                }
                
                this.stock = [...this.cards];
                this.cards = [];
            }

            /**
             * æ¸²æŸ“æ¸¸æˆç•Œé¢
             */
            render() {
                this.renderColumns();
                this.renderFoundation();
                this.renderStockPile();
            }

            /**
             * æ¸²æŸ“10åˆ—ç‰Œ
             */
            renderColumns() {
                const board = document.getElementById('gameBoard');
                if (!board) return;
                board.innerHTML = '';
                
                this.columns.forEach((column, colIndex) => {
                    const colEl = document.createElement('div');
                    colEl.className = 'column';
                    colEl.dataset.colIndex = colIndex;
                    
                    let currentTop = 0;
                    
                    column.forEach((card, cardIndex) => {
                        const cardEl = this.createCardElement(card);
                        const computedStyle = getComputedStyle(document.documentElement);
                        const baseOffset = parseFloat(computedStyle.getPropertyValue('--card-offset')) || 30;
                        const cardOffset = column.length > 15 
                            ? Math.max(baseOffset * 0.5, baseOffset - (column.length - 15)) 
                            : baseOffset;
                        const offset = card.faceUp ? cardOffset : 18;
                        
                        cardEl.style.top = `${currentTop}px`;
                        cardEl.style.zIndex = cardIndex;
                        currentTop += offset;
                        colEl.appendChild(cardEl);
                    });
                    
                    if (column.length === 0) {
                        const computedStyle = getComputedStyle(document.documentElement);
                        const colWidth = parseFloat(computedStyle.getPropertyValue('--column-width')) || 100;
                        const colHeight = parseFloat(computedStyle.getPropertyValue('--card-height')) || 145;
                        const placeholder = document.createElement('div');
                        placeholder.style.cssText = `width:${colWidth}px;height:${colHeight}px;border:2px dashed rgba(255,255,255,0.3);border-radius:8px;position:absolute;top:0;left:0;`;
                        colEl.appendChild(placeholder);
                    }
                    
                    board.appendChild(colEl);
                });
            }

            /**
             * åˆ›å»ºçº¸ç‰ŒDOMå…ƒç´ 
             */
            createCardElement(card) {
                const cardEl = document.createElement('div');
                cardEl.className = `card ${card.faceUp ? 'face-up' : 'face-down'}`;
                cardEl.dataset.cardId = card.id;
                
                if (card.faceUp) {
                    cardEl.innerHTML = `
                        <div class="card-face">
                            <div class="card-corner top">
                                <span class="card-rank">${card.rankDisplay}</span>
                                <span class="card-suit-small">${card.suit}</span>
                            </div>
                            <div class="card-center">${card.suit}</div>
                            <div class="card-corner bottom">
                                <span class="card-rank">${card.rankDisplay}</span>
                                <span class="card-suit-small">${card.suit}</span>
                            </div>
                        </div>
                        <div class="card-back"></div>
                    `;
                } else {
                    cardEl.innerHTML = `<div class="card-back"></div>`;
                }
                
                return cardEl;
            }

            /**
             * æ¸²æŸ“å›æ”¶åŒº
             */
            renderFoundation() {
                const slot = document.querySelector('.foundation-slot');
                if (!slot) return;
                
                slot.innerHTML = '';
                const completedCount = this.foundation.length;
                
                const computedStyle = getComputedStyle(document.documentElement);
                const scale = parseFloat(computedStyle.getPropertyValue('--scale')) || 1;
                const cardWidth = 80 * scale;
                const cardSpacing = 35 * scale;
                const slotWidth = completedCount * cardWidth + (completedCount - 1) * cardSpacing;
                slot.style.width = `${slotWidth}px`;
                
                for (let i = 0; i < completedCount; i++) {
                    const card = this.foundation[i][0];
                    const cardEl = this.createCardElement(card);
                    cardEl.style.position = 'absolute';
                    cardEl.style.top = `${10 * scale}px`;
                    cardEl.style.left = `${i * cardSpacing}px`;
                    slot.appendChild(cardEl);
                }
            }

            /**
             * æ¸²æŸ“å‘ç‰ŒåŒº
             */
            renderStockPile() {
                const stockPile = document.getElementById('stockPile');
                if (!stockPile) return;
                
                if (this.stock.length === 0) {
                    stockPile.innerHTML = `
                        <div class="card" style="opacity: 0.3;">
                            <div class="card-back"></div>
                        </div>
                        <span class="stock-count" id="stockCount">0</span>
                    `;
                    stockPile.classList.add('disabled');
                } else {
                    stockPile.innerHTML = `
                        <div class="card">
                            <div class="card-back"></div>
                        </div>
                        <span class="stock-count" id="stockCount">${this.stock.length}</span>
                    `;
                    this.updateStockPileState();
                }
            }

            /**
             * æ›´æ–°å‘ç‰ŒåŒºçŠ¶æ€
             */
            updateStockPileState() {
                const stockPile = document.getElementById('stockPile');
                if (!stockPile) return;
                
                const canDeal = this.columns.every(col => 
                    col.length > 0 && col.some(card => card.faceUp)
                );
                
                if (canDeal && this.stock.length > 0) {
                    stockPile.classList.remove('disabled');
                } else {
                    stockPile.classList.add('disabled');
                }
            }

            /**
             * ç»‘å®šäº‹ä»¶
             */
            bindEvents() {
                document.getElementById('stockPile').addEventListener('click', () => {
                    if (!document.getElementById('stockPile').classList.contains('disabled')) {
                        this.dealCards();
                    }
                });

                document.getElementById('gameBoard').addEventListener('mousedown', (e) => {
                    this.handleMouseDown(e);
                });

                document.addEventListener('mousemove', (e) => {
                    this.handleMouseMove(e);
                });

                document.addEventListener('mouseup', (e) => {
                    this.handleMouseUp(e);
                });

                document.getElementById('gameBoard').addEventListener('touchstart', (e) => {
                    this.handleTouchStart(e);
                }, { passive: false });

                document.addEventListener('touchmove', (e) => {
                    this.handleTouchMove(e);
                }, { passive: false });

                document.addEventListener('touchend', (e) => {
                    this.handleTouchEnd(e);
                });

                document.getElementById('restartBtn').addEventListener('click', () => {
                    this.restart();
                });

                document.getElementById('rotateBtn').addEventListener('click', () => {
                    this.requestLandscape();
                });

                document.getElementById('keepPortraitBtn').addEventListener('click', () => {
                    this.keepPortrait();
                });
            }

            /**
             * æ£€æµ‹æ˜¯å¦éœ€è¦æ˜¾ç¤ºæ¨ªå±æç¤º
             */
            checkOrientation() {
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                if (!isMobile) return;
                
                if (window.innerHeight > window.innerWidth) {
                    document.getElementById('orientationModal').classList.add('show');
                }
            }

            /**
             * è¯·æ±‚æ¨ªå±
             */
            async requestLandscape() {
                if (screen.orientation && screen.orientation.lock) {
                    try {
                        await screen.orientation.lock('landscape');
                        document.getElementById('orientationModal').classList.remove('show');
                    } catch (e) {
                        this.showRotateHint();
                    }
                } else {
                    this.showRotateHint();
                }
            }

            /**
             * æ˜¾ç¤ºæ—‹è½¬æç¤º
             */
            showRotateHint() {
                document.getElementById('orientationModal').classList.remove('show');
                this.showMessage('è¯·æ‰‹åŠ¨æ—‹è½¬æ‰‹æœºè‡³æ¨ªå±');
            }

            /**
             * ä¿æŒç«–å±é€‰æ‹©
             */
            keepPortrait() {
                document.getElementById('orientationModal').classList.remove('show');
            }

            /**
             * å¼€å§‹è®¡æ—¶å™¨
             */
            startTimer() {
                this.stopTimer();
                this.startTime = Date.now();
                this.updateTimer();
                this.timerInterval = setInterval(() => this.updateTimer(), 1000);
            }

            /**
             * åœæ­¢è®¡æ—¶å™¨
             */
            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }

            /**
             * æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
             */
            updateTimer() {
                const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timerEl = document.getElementById('timer');
                if (timerEl) {
                    timerEl.textContent = `ç”¨æ—¶ï¼š${minutes}åˆ†${seconds}ç§’`;
                }
            }

            /**
             * è·å–æ ¼å¼åŒ–ç”¨æ—¶
             */
            getElapsedTime() {
                const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                return `${minutes}åˆ†${seconds}ç§’`;
            }

            /**
             * å‘ç‰Œï¼šæ¯è½®å‘10å¼ 
             */
            dealCards() {
                const canDeal = this.columns.every(col => 
                    col.length > 0 && col.some(card => card.faceUp)
                );

                if (!canDeal) {
                    this.showMessage('æ¯åˆ—éœ€è¦æœ‰æ­£é¢æœä¸Šçš„ç‰Œæ‰èƒ½å‘ç‰Œ');
                    return;
                }

                if (this.dealCount >= 5 || this.stock.length === 0) {
                    this.showMessage('æ²¡æœ‰æ›´å¤šç‰Œäº†');
                    return;
                }

                for (let col = 0; col < 10; col++) {
                    if (this.stock.length > 0) {
                        const card = this.stock.pop();
                        card.faceUp = true;
                        this.columns[col].push(card);
                    }
                }

                this.dealCount++;
                this.render();
                this.checkSequences();
                this.updateStockPileState();
                this.checkDeadlock();
            }

            /**
             * å¤„ç†é¼ æ ‡æŒ‰ä¸‹
             */
            handleMouseDown(e) {
                const cardEl = e.target.closest('.card');
                if (!cardEl) return;

                const column = cardEl.closest('.column');
                const colIndex = parseInt(column.dataset.colIndex);
                const cardId = cardEl.dataset.cardId;
                const columnCards = this.columns[colIndex];

                let cardIndex = columnCards.findIndex(c => c.id === cardId);
                if (cardIndex === -1) return;

                const card = columnCards[cardIndex];

                if (!card.faceUp) {
                    return;
                }

                if (this.isValidDrag(columnCards, cardIndex)) {
                    this.startDrag(e, colIndex, cardIndex);
                }
            }

            /**
             * æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‹–åŠ¨
             */
            isValidDrag(columnCards, cardIndex) {
                if (!columnCards[cardIndex].faceUp) return false;

                for (let i = cardIndex; i < columnCards.length - 1; i++) {
                    const current = columnCards[i];
                    const next = columnCards[i + 1];

                    if (current.suit !== next.suit || current.rank !== next.rank + 1) {
                        return false;
                    }
                }

                return true;
            }

            /**
             * å¼€å§‹æ‹–æ‹½
             */
            startDrag(e, colIndex, cardIndex) {
                const column = this.columns[colIndex];
                const cards = column.slice(cardIndex);
                const columnEl = document.querySelector(`.column[data-col-index="${colIndex}"]`);
                const cardEls = columnEl ? columnEl.querySelectorAll('.card') : [];
                
                this.dragState = {
                    colIndex,
                    cardIndex,
                    cards,
                    cardEls: Array.from(cardEls).slice(cardIndex),
                    startX: e.clientX,
                    startY: e.clientY,
                    initialPositions: [],
                    offsetX: 0,
                    offsetY: 0
                };

                this.dragState.cardEls.forEach(el => {
                    this.dragState.initialPositions.push({
                        left: el.offsetLeft,
                        top: el.offsetTop
                    });
                });

                this.selectedCard = { colIndex, cardIndex };
                this.highlightSelected(cards);

                this.dragState.cardEls.forEach(el => el.classList.add('dragging'));
            }

            /**
             * å¤„ç†é¼ æ ‡ç§»åŠ¨
             */
            handleMouseMove(e) {
                if (!this.dragState) return;

                const dx = e.clientX - this.dragState.startX;
                const dy = e.clientY - this.dragState.startY;

                this.dragState.offsetX = dx;
                this.dragState.offsetY = dy;

                this.dragState.cardEls.forEach((el, index) => {
                    const pos = this.dragState.initialPositions[index];
                    el.style.left = `${pos.left + dx}px`;
                    el.style.top = `${pos.top + dy}px`;
                });

                this.highlightDropTarget(e.clientX, e.clientY);
            }

            /**
             * é«˜äº®æ‹–åŠ¨çš„ç‰Œ
             */
            highlightSelected(cards) {
                document.querySelectorAll('.card.selected').forEach(el => {
                    el.classList.remove('selected');
                });

                cards.forEach(card => {
                    const el = document.querySelector(`[data-card-id="${card.id}"]`);
                    if (el) el.classList.add('selected');
                });
            }

            /**
             * é«˜äº®å¯æ”¾ç½®çš„ç›®æ ‡
             */
            highlightDropTarget(mouseX, mouseY) {
                document.querySelectorAll('.card.drop-target').forEach(el => {
                    el.classList.remove('drop-target');
                });

                const targetCard = this.getCardAtPosition(mouseX, mouseY);
                if (targetCard) {
                    const el = document.querySelector(`[data-card-id="${targetCard.id}"]`);
                    if (el) el.classList.add('drop-target');
                }
            }

            /**
             * è·å–æŒ‡å®šä½ç½®çš„ç‰Œ
             */
            getCardAtPosition(x, y) {
                const elements = document.elementsFromPoint(x, y);
                for (const el of elements) {
                    if (el.classList.contains('card') && el.classList.contains('face-up')) {
                        const cardId = el.dataset.cardId;
                        for (const column of this.columns) {
                            const card = column.find(c => c.id === cardId);
                            if (card) return card;
                        }
                    }
                }
                return null;
            }

            /**
             * å¤„ç†é¼ æ ‡æ¾å¼€
             */
            handleMouseUp(e) {
                if (!this.dragState) return;

                this.dragState.cardEls.forEach(el => {
                    el.classList.remove('dragging');
                    el.classList.remove('drop-target');
                });

                const targetCard = this.getCardAtPosition(e.clientX, e.clientY);
                const placed = this.tryPlaceCard(targetCard);

                if (!placed) {
                    this.dragState.cardEls.forEach((el, index) => {
                        const pos = this.dragState.initialPositions[index];
                        el.style.left = `${pos.left}px`;
                        el.style.top = `${pos.top}px`;
                    });
                }

                this.dragState = null;
                this.selectedCard = null;
                this.clearHighlights();
            }

            /**
             * å¤„ç†è§¦æ‘¸å¼€å§‹
             */
            handleTouchStart(e) {
                e.preventDefault();
                if (e.touches.length !== 1) return;

                const touch = e.touches[0];
                const x = touch.clientX;
                const y = touch.clientY;

                // å°è¯•æ‰¾åˆ°è§¦æ‘¸ç‚¹ä¸‹çš„å¡ç‰‡
                let cardEl = null;
                const elements = document.elementsFromPoint(x, y);
                for (const el of elements) {
                    if (el.classList.contains('card')) {
                        cardEl = el;
                        break;
                    }
                }
                
                if (!cardEl) return;

                const column = cardEl.closest('.column');
                if (!column) return;

                const colIndex = parseInt(column.dataset.colIndex);
                const cardId = cardEl.dataset.cardId;
                const columnCards = this.columns[colIndex];

                let cardIndex = columnCards.findIndex(c => c.id === cardId);
                if (cardIndex === -1) return;

                const card = columnCards[cardIndex];
                if (!card.faceUp) return;

                if (this.isValidDrag(columnCards, cardIndex)) {
                    this.startDrag({ clientX: x, clientY: y, target: cardEl }, colIndex, cardIndex);
                }
            }

            /**
             * å¤„ç†è§¦æ‘¸ç§»åŠ¨
             */
            handleTouchMove(e) {
                if (!this.dragState) return;
                e.preventDefault();
                if (e.touches.length !== 1) return;

                const touch = e.touches[0];
                const x = touch.clientX;
                const y = touch.clientY;

                const dx = x - this.dragState.startX;
                const dy = y - this.dragState.startY;

                this.dragState.offsetX = dx;
                this.dragState.offsetY = dy;

                this.dragState.cardEls.forEach((el, index) => {
                    const pos = this.dragState.initialPositions[index];
                    el.style.left = `${pos.left + dx}px`;
                    el.style.top = `${pos.top + dy}px`;
                });

                this.highlightDropTarget(x, y);
            }

            /**
             * å¤„ç†è§¦æ‘¸ç»“æŸ
             */
            handleTouchEnd(e) {
                if (!this.dragState) return;
                if (e.changedTouches.length !== 1) return;

                const touch = e.changedTouches[0];
                const x = touch.clientX;
                const y = touch.clientY;

                this.dragState.cardEls.forEach(el => {
                    el.classList.remove('dragging');
                    el.classList.remove('drop-target');
                });

                const targetCard = this.getCardAtPosition(x, y);
                const placed = this.tryPlaceCard(targetCard);

                if (!placed) {
                    this.dragState.cardEls.forEach((el, index) => {
                        const pos = this.dragState.initialPositions[index];
                        el.style.left = `${pos.left}px`;
                        el.style.top = `${pos.top}px`;
                    });
                }

                this.dragState = null;
                this.selectedCard = null;
                this.clearHighlights();
            }

            /**
             * å¡ç‰‡æ™ƒåŠ¨åŠ¨ç”»
             */
            shakeCard(cardEl) {
                if (!cardEl) return;
                cardEl.classList.add('invalid-move');
                setTimeout(() => {
                    cardEl.classList.remove('invalid-move');
                }, 300);
            }

            /**
             * å°è¯•æ”¾ç½®ç‰Œç»„
             */
            tryPlaceCard(targetCard) {
                const { colIndex, cardIndex, cards, startX, startY, offsetX, offsetY } = this.dragState;
                const mouseX = startX + offsetX;
                const mouseY = startY + offsetY;

                let targetColIndex = -1;
                const columns = document.querySelectorAll('.column');

                for (let i = 0; i < columns.length; i++) {
                    const rect = columns[i].getBoundingClientRect();
                    if (mouseX >= rect.left && mouseX <= rect.right) {
                        targetColIndex = i;
                        break;
                    }
                }

                if (targetColIndex === -1) return false;
                if (targetColIndex === colIndex) return false;

                const targetColumn = this.columns[targetColIndex];
                const firstCard = cards[0];

                if (targetColumn.length === 0) {
                    this.moveCards(colIndex, cardIndex, targetColIndex);
                    return true;
                }

                const topCard = targetColumn[targetColumn.length - 1];
                if (topCard.faceUp && topCard.suit === firstCard.suit && topCard.rank === firstCard.rank + 1) {
                    this.moveCards(colIndex, cardIndex, targetColIndex);
                    return true;
                }

                return false;
            }

            /**
             * ç§»åŠ¨ç‰Œç»„
             */
            moveCards(fromColIndex, fromCardIndex, toColIndex) {
                this.saveState();

                const cards = this.columns[fromColIndex].splice(fromCardIndex);
                this.columns[toColIndex].push(...cards);

                const fromColumn = this.columns[fromColIndex];
                if (fromColumn.length > 0) {
                    const topCard = fromColumn[fromColumn.length - 1];
                    if (!topCard.faceUp) {
                        topCard.faceUp = true;
                    }
                }

                this.render();
                this.checkSequences();
                this.updateStockPileState();
                this.checkDeadlock();
            }

            /**
             * æ£€æµ‹ç‰Œæ˜¯å¦è¿ç»­é€’å‡
             */
            isValidSequence(column, startIndex) {
                if (startIndex < 12) return false;
                
                const suit = column[startIndex].suit;

                for (let j = 0; j < 13; j++) {
                    const pos = startIndex - j;
                    const card = column[pos];
                    const expectedRank = 1 + j;
                    
                    if (!card) return false;
                    if (card.suit !== suit || card.rank !== expectedRank || !card.faceUp) {
                        return false;
                    }
                }
                return true;
            }

            /**
             * æ£€æŸ¥æ˜¯å¦å½¢æˆK-Aåºåˆ—å¹¶å›æ”¶
             */
            checkSequences() {
                let foundSequence = false;

                for (let colIndex = 0; colIndex < this.columns.length; colIndex++) {
                    const column = this.columns[colIndex];
                    if (column.length < 13) continue;

                    for (let i = column.length - 13; i < column.length; i++) {
                        if (column[i].rank !== 1) continue;
                        
                        if (this.isValidSequence(column, i)) {
                            const sequence = [];
                            for (let k = 0; k < 13; k++) {
                                sequence.push(column.pop());
                            }
                            sequence.reverse();

                            this.foundation.push(sequence);
                            this.completedCount++;
                            foundSequence = true;

                            if (i >= 13) {
                                const cardAbove = column[i - 13];
                                if (cardAbove && !cardAbove.faceUp) {
                                    cardAbove.faceUp = true;
                                }
                            }
                            break;
                        }
                    }
                }

                if (foundSequence) {
                    this.renderColumns();
                    this.renderFoundation();
                    this.renderStockPile();
                    
                    if (this.completedCount >= 8) {
                        this.stopTimer();
                        document.getElementById('winModal').classList.add('show');
                    }
                    this.checkSequences();
                }
            }

            /**
             * æ¸…é™¤é«˜äº®
             */
            clearHighlights() {
                document.querySelectorAll('.card.selected, .card.drop-target').forEach(el => {
                    el.classList.remove('selected', 'drop-target');
                });
            }

            /**
             * æ˜¾ç¤ºæç¤ºä¿¡æ¯
             */
            showMessage(text) {
                const msg = document.getElementById('message');
                msg.textContent = text;
                msg.classList.add('show');
                setTimeout(() => msg.classList.remove('show'), 2000);
            }

            /**
             * ç§»åŠ¨ç‰Œç»„
             */
            moveCards(fromColIndex, fromCardIndex, toColIndex) {
                const cards = this.columns[fromColIndex].splice(fromCardIndex);
                this.columns[toColIndex].push(...cards);

                const fromColumn = this.columns[fromColIndex];
                if (fromColumn.length > 0) {
                    const topCard = fromColumn[fromColumn.length - 1];
                    if (!topCard.faceUp) {
                        topCard.faceUp = true;
                    }
                }

                this.render();
                this.checkSequences();
                this.updateStockPileState();
                this.checkDeadlock();
            }

            /**
             * æ£€æµ‹ç‰Œæ˜¯å¦è¿ç»­é€’å‡
             */
            findPossibleMoves() {
                const moves = [];

                for (let fromCol = 0; fromCol < 10; fromCol++) {
                    const column = this.columns[fromCol];
                    if (column.length === 0) continue;

                    for (let cardIndex = 0; cardIndex < column.length; cardIndex++) {
                        const card = column[cardIndex];
                        if (!card.faceUp) continue;

                        if (!this.isValidDrag(column, cardIndex)) continue;

                        const dragCards = column.slice(cardIndex);

                        for (let toCol = 0; toCol < 10; toCol++) {
                            if (toCol === fromCol) continue;

                            const targetColumn = this.columns[toCol];

                            if (targetColumn.length === 0) {
                                moves.push({ fromCol, cardIndex, toCol });
                            } else {
                                const topCard = targetColumn[targetColumn.length - 1];
                                if (topCard.faceUp && topCard.suit === dragCards[0].suit && topCard.rank === dragCards[0].rank + 1) {
                                    moves.push({ fromCol, cardIndex, toCol });
                                }
                            }
                        }
                    }
                }

                return moves;
            }

            /**
             * æ£€æŸ¥æ­»é”
             */
            checkDeadlock() {
                if (this.completedCount >= 8) return;

                if (this.stock.length > 0) return;

                const canDeal = this.columns.every(col => 
                    col.length === 0 || col.some(card => card.faceUp)
                );

                if (!canDeal) return;

                const moves = this.findPossibleMoves();
                if (moves.length === 0) {
                    setTimeout(() => {
                        document.getElementById('deadlockModal').classList.add('show');
                    }, 500);
                }
            }

            /**
             * é‡æ–°å¼€å§‹æ¸¸æˆ
             */
            restart() {
                document.getElementById('winModal').classList.remove('show');
                document.getElementById('deadlockModal').classList.remove('show');
                this.stopTimer();
                this.columns = [];
                this.stock = [];
                this.foundation = [];
                this.dragState = null;
                this.selectedCard = null;
                this.completedCount = 0;
                this.dealCount = 0;

                this.createDeck();
                this.shuffleDeck();
                this.dealInitialCards();
                this.render();
                this.startTimer();
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        const game = new SpiderSolitaire();
    </script>
</body>
</html>
